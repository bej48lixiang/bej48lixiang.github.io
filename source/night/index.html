<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <link rel='stylesheet' type='text/css' href='night.css'>
    <script type="text/javascript" src="http://lib.sinaapp.com/js/jquery/2.0.3/jquery-2.0.3.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var rank_name = ['沙发', '板凳', '地板'];
        $('#generate').click(function() {
            var records = $('textarea').val();
            var pretitle = $('#title').val()
            $('body').empty();
            var container = $('<div class="container" />');
            var bgimg = $('<div class="bgimg" />');
            var table = $('<table />');
            var val_list = [];
            var recre = /\s*(?:(\d+-\d+-\d+) (\d+:\d+:\d+) (.+?)\((\d+)\)|(?:【[^】]+】)?(.+?)\((\d+)\) (\d+:\d+:\d+))\n([^\0]+?)(?:\n+|$)/g
            var lastIdx = 0;
            var unproc = [];
            var title = null;
            while ((result = recre.exec(records)) != null) {
                if (result.index > lastIdx) {
                    unproc.push(records.substr(lastIdx, result.index - lastIdx));
                }
                lastIdx = recre.lastIndex;
                var context = result[8];
                var qqid = result[4] || result[6];
                var qqname = result[3] || result[5];
                var rtime = result[2] || result[7];
                if (/^(#[^#]+#)(.*)$/.exec(context)) {
                    title = /^(#[^#]+#)(.*)$/.exec(context)[1];
                } else {
                    continue;
                }
                var imgsrc = 'http://q1.qlogo.cn/g?b=qq&nk=' + qqid + '&s=100&t=' + (+new Date);
                var rank_tag = (val_list.length + 1) + '楼';
                if (val_list.length in rank_name) {
                    rank_tag = rank_name[val_list.length];
                }
                val_list.push($('<tr><td><img src="' +
                    imgsrc + '"></td><td><span class="name">' +
                    qqname + '</span><span class="date">' +
                    rank_tag + '&nbsp;&nbsp;' + rtime + '</span><br>' +
                    context.replace(/^(#[^#]+#)(.*)$/, '<span class="tag">$1</span>$2') + '</td></tr>'));
            }
            if (unproc.length != 0) {
                alert('以下数据未被处理（由于格式错误等原因）：\n' + unproc.join('\n'))
            }
            alert('共检测到' + val_list.length + '条有效记录');
            var th = $('<tr><th colspan=2>' + pretitle + '<br><span class="tag">' + title + '</span></th></tr>');
            table.append(th);
            for (var i = 0; i < val_list.length; i++) {
                table.append(val_list[i]);
            }
            container.append(bgimg, table).appendTo('body');
        })
    })
    </script>
</head>

<body>
    <textarea style="width: 95%; top: 30px; bottom: 10px; position: absolute;">
请在此粘贴聊天记录

以下是样例
==========

2016-06-23 20:52:16 十分想见罗雪丽(907608325)
#夏天最爱吃的冷饮# 吃空调

2016-06-23 20:52:29 胜利(190744493)
#夏天最爱吃的冷饮# 冰镇白花蛇草水算吗

2016-06-23 20:52:48 Zeyuan0w0(240472853)
#夏天最爱吃的冷饮# 陈倩楠爱吃什么我就爱吃什么

2016-06-23 20:53:29 残梦花舞(1028562040)
#夏天最爱吃的冷饮# 西瓜最中心的那一块，虽然不是“饮”

2016-06-23 20:53:38 十分想见罗雪丽(907608325)
#夏天最爱吃的冷饮# 冰镇啤酒，冰棍的话就是苦咖啡

2016-06-23 20:53:47 理想主义的玄阳(463017923)
#夏天最爱吃的冷饮# 现在不敢吃冷饮了。。太胖了

2016-06-23 20:53:57 LY__羊肉串儿(215750953)
#夏天最爱吃的冷饮# 胃不好，不敢多吃

2016-06-23 20:54:25 想哥的女人西西(243046571)
#夏天最爱吃的冷饮# 柠檬水一生推。

2016-06-23 20:55:59 单推渣总的熊猫(919225299)
#夏天最爱吃的冷饮# 冰镇的柠檬茶 还有各种星冰乐

2016-06-23 20:56:51 park乖乖(945480609)
#夏天最爱吃的冷饮# 北冰洋

2016-06-23 20:57:01 零丸(1274979702)
#夏天最爱吃的冷饮# 冰镇大麻

2016-06-23 20:58:47 李想的脑门儿(1007571564)
#夏天最爱吃的冷饮# 星爸爸的抹茶星冰乐

2016-06-23 21:00:26 李想的脑门儿(1007571564)
#夏天最爱吃的冷饮# 悠唐特供的“李想快发唱吧汽水”

2016-06-23 21:03:01 北京-萝卜(792627742)
#夏天最爱吃的冷饮# 伊利巧乐兹 冻过的柠檬茶

2016-06-23 21:05:16 Zeyuan0w0(240472853)
#夏天最爱吃的冷饮# 便宜好喝的绿豆沙冰

2016-06-23 21:06:30 正一(592360972)
#夏天最爱吃的冷饮# 绿豆汤 不用很冰就特别棒

2016-06-23 21:06:56 千-。-夜(798462430)
#夏天最爱吃的冷饮# wrc2号请吃饭

2016-06-23 21:12:11 铯版(280833822)
#夏天最爱吃的冷饮# 随变
    </textarea>
    <input type="button" name="test" value="生成" id="generate">
    <textarea id="title" style="height: 20px;">今日话题</textarea>
</body>
